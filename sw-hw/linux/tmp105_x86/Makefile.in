# Configure this 5 variables according to your computer environment
CC = gcc
CBMC = cbmc
GTCC = goto-cc
GTINST = goto-instrument
KLEE = klee

LINUX_SRC = ..
GCC_INCLUDE =  ../../gcc-include
QEMU_SRC = ../../../qemu-hw
GEN = generated

UNWIND_NO = 2
#PROP_NO = 21

# Source code
# --> UGLY: The other files are included in  main.c
#     TODO: Does anyone know how to make cbmc recognize "-include"?
SRC = main.c 

OBJS = $(SRC:%.c=%.o)

HOSTCFLAGS = -Wall -Wmissing-prototypes -Wstrict-prototypes -O2 \
             -fomit-frame-pointer 

CFLAGS = -std=gnu99 -nostdinc $(MYLIB) $(KLIB) -I . -D__KERNEL__ $(HOSTCFLAGS) \
         -D_SYS_ -DCONFIG_I2C -DCONFIG_PM

LDFLAGS = 

KLIB = -I $(LINUX_SRC)/arch/x86/include/  \
       -I $(LINUX_SRC)/arch/x86/kernel/ \
       -I $(LINUX_SRC)/include/ \
       -I $(LINUX_SRC)/lib/ \
       -I $(LINUX_SRC)/drivers/ \
       -I $(LINUX_SRC)/drivers/hwmon/

HLIB = -I $(GCC_INCLUDE)/

QLIB = -I $(QEMU_SRC)/

MYLIB = -I modlib/

VERDEF = -D__KERNEL__ -D_SYS_ -DCONFIG_I2C -U__i386__ -DI2C_BENCHMARK_PROP_$(PROP_NO)

CFLAGS = -std=gnu99 -nostdinc $(MYLIB) $(KLIB) $(QLIB) -I . -D__KERNEL__ $(HOSTCFLAGS) -D_SYS_ 

LDFLAGS = -l rt

# Not used right now
%.o : %.c
	@echo Compiling: $<
	$(CC) $(CFLAGS) -include $(GEN)/autoconf.h -c -o $@ $<

test.bc: CFLAGS += --emit-llvm 
test.bc:
	@echo ------ Compiling: $(SRC)
	$(CC) $(CFLAGS) $(HLIB) $(SRC) -c -g -o $@ -nostdinc -include\
	$(GEN)/autoconf.h $(VERDEF) 

klee: test.bc
	@echo ------ Klee:
	$(KLEE) --optimize  --libc=uclibc $<

mysystem:
	@echo Compiling: $(SRC)
	@$(GTCC) $(SRC) -o $@ -nostdinc -include $(GEN)/autoconf.h $(MYLIB) \
        $(KLIB) $(HLIB) $(QLIB) -I ./ $(VERDEF) -D_CBMC_

verify: mysystem
	@echo Verifying: $(SRC)
	@$(CBMC) --unwind $(UNWIND_NO) --no-library $<

dot: mysystem
	@echo Build CFG: $(SRC)
	@$(GTINST) $< mysystem.dot --dot

clean:
	@echo Clean folder...
	@rm mysystem
