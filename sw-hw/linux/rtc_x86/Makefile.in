# Configure the first 5 variables according to your computer environment
CC = gcc
CBMC = cbmc
GTCC = goto-cc
GTINST = goto-instrument
KLEE = klee

LINUX_SRC = ..
QEMU_SRC = ../../../qemu-hw
GCC_INCLUDE = ../../gcc-include 
GEN = generated

UNWIND = 21
#PROP_NO = 11

# Source code
# --> UGLY: The other files are included in  main.c
#     TODO: Does anyone know how to make cbmc recognize "-include"?
SRC = main.c #\
      $(LINUX_SRC)/drivers/rtc-cmos.c \
      $(LINUX_SRC)/arch/x86/kernel/rtc.c \
      $(LINUX_SRC)/lib/bcd.c \
      $(LINUX_SRC)/drivers/base/platform.c \
      $(LINUX_SRC)/drivers/base/driver.c \

OBJS = $(SRC:%.c=%.o)

HOSTCFLAGS = -Wall -Wmissing-prototypes -Wstrict-prototypes -O2 \
             -fomit-frame-pointer 

CFLAGS = -std=gnu99 -nostdinc $(MYLIB) $(KLIB) $(QLIB) -I . -D__KERNEL__ $(HOSTCFLAGS) -D_SYS_ 

LDFLAGS = 

KLIB = -I $(LINUX_SRC)/arch/x86/include/  \
       -I $(LINUX_SRC)/arch/x86/kernel/ \
       -I $(LINUX_SRC)/include/ \
       -I $(LINUX_SRC)/lib/ \
       -I $(LINUX_SRC)/drivers/

HLIB = -I $(GCC_INCLUDE)/

QLIB = -I $(QEMU_SRC)/

MYLIB = -I modlib/

# Add -D__EXPOSE_BUG__ if you want to expose the bug
VERDEF = -D__KERNEL__ -DRTC_BENCHMARK_PROP_$(PROP_NO) 

# Not used right now
%.o : %.c
	@echo Compiling: $<
	$(CC) $(CFLAGS) -include $(GEN)/autoconf.h -c -o $@ $<

test.bc: CFLAGS += --emit-llvm 
test.bc:
	@echo ------ Compiling: $(SRC)
	$(CC) $(CFLAGS) $(HLIB) $(SRC) -c -g -o $@ -nostdinc -include\
	$(GEN)/autoconf.h $(VERDEF) 

klee: test.bc
	@echo ------ Klee:
	$(KLEE) --optimize  --libc=uclibc $<

mysystem:
	@echo Compiling: $(SRC)
	@$(GTCC) $(SRC) -o $@ -nostdinc -include $(GEN)/autoconf.h $(MYLIB) \
        $(KLIB) $(HLIB) $(QLIB) -I ./ -D_CBMC_ -D__NO_TIMER__ $(VERDEF)

verify: mysystem
	@echo Verifying: $(SRC)
	@$(CBMC) --unwind $(UNWIND) --no-library $<

dot: mysystem
	@echo Build CFG: $(SRC)
	@$(GTINST) $< mysystem.dot --dot

clean:
	@echo Clean folder...
	@rm mysystem
